import"./game-BSviGGm9.js";import"./GLTFLoader-DwKRNB9j.js";class z{constructor(){this.hitmarker=document.getElementById("hitmarker"),this.line1=this.hitmarker.querySelector(".line-1"),this.line2=this.hitmarker.querySelector(".line-2")}show(){this.resetAnimations(),setTimeout(()=>{this.line1.style.animation="xHitmarkerShow 0.4s ease-out forwards",this.line2.style.animation="xHitmarkerShow2 0.4s ease-out forwards",setTimeout(()=>{this.resetAnimations()},400)},10)}resetAnimations(){this.line1.style.animation="none",this.line2.style.animation="none",this.line1.offsetWidth,this.line2.offsetWidth}}class F{constructor(){this.effect=document.getElementById("screenEventEffect"),this.timeout=null}showEffect(e=.5,i="damage"){this.effect.classList.remove(...this.effect.classList),this.effect.classList.add(i),this.timeout&&(clearTimeout(this.timeout),this.effect.style.opacity="0");const a=.3+e*.5;this.effect.style.opacity=a.toString(),this.timeout=setTimeout(()=>{this.effect.style.opacity="0",this.timeout=null},300)}}class L{constructor(e,i,a){this.maxHealth=e,this.health=a,this.dashCooldown=0,this.maxDashCooldown=i,this.isDashReady=!0}createGUI(){this.guiContainer=document.createElement("div"),this.guiContainer.id="gameGUI",this.guiContainer.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        `,document.body.appendChild(this.guiContainer),this.createHealthBar(),this.createDashBar(),this.createControlButtons()}createHealthBar(){this.healthBarContainer=document.createElement("div"),this.healthBarContainer.style.cssText=`
            position: absolute;
            bottom: 60px;
            left: 20px;
            width: 300px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            pointer-events: auto;
        `,this.healthBarFill=document.createElement("div"),this.healthBarFill.style.cssText=`
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #00ff88, #00ff37, #00ff00);
            transition: width 0.3s ease;
        `,this.healthBarText=document.createElement("div"),this.healthBarText.style.cssText=`
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 1px 1px 2px black;
            z-index: 1;
        `,this.healthBarText.textContent=`HEALTH: ${this.health}/${this.maxHealth}`,this.healthBarContainer.appendChild(this.healthBarFill),this.healthBarContainer.appendChild(this.healthBarText),this.guiContainer.appendChild(this.healthBarContainer)}createDashBar(){this.dashBarContainer=document.createElement("div"),this.dashBarContainer.style.cssText=`
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            pointer-events: auto;
        `,this.dashBarFill=document.createElement("div"),this.dashBarFill.style.cssText=`
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #0066ff, #00ccff);
            transition: width 0.1s linear;
        `,this.dashBarText=document.createElement("div"),this.dashBarText.style.cssText=`
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 1px 1px 2px black;
            z-index: 1;
        `,this.dashBarText.textContent="DASH: READY",this.dashBarContainer.appendChild(this.dashBarFill),this.dashBarContainer.appendChild(this.dashBarText),this.guiContainer.appendChild(this.dashBarContainer)}createControlButtons(){this.buttonsContainer=document.createElement("div"),this.buttonsContainer.style.cssText=`
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
        `,this.menuButton=document.createElement("button"),this.menuButton.style.cssText=`
            padding: 12px 24px;
            background: linear-gradient(45deg, #d40c0c, #bb1212);
            color: white;
            border: 2px solid #000000;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        `,this.menuButton.textContent="MENU",this.menuButton.onmouseover=()=>this.menuButton.style.background="linear-gradient(45deg, #A0522D, #8B4513)",this.menuButton.onmouseout=()=>this.menuButton.style.background="linear-gradient(45deg, #8B4513, #A0522D)",this.menuButton.onclick=()=>this.openMenu(),this.settingsButton=document.createElement("button"),this.settingsButton.style.cssText=`
            padding: 12px 24px;
            background: linear-gradient(45deg, #707070, #6B6B6B);
            color: white;
            border: 2px solid #2A2A2A;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        `,this.settingsButton.textContent="SETTINGS",this.settingsButton.onmouseover=()=>this.settingsButton.style.background="linear-gradient(45deg, #6B6B6B, #4A4A4A)",this.settingsButton.onmouseout=()=>this.settingsButton.style.background="linear-gradient(45deg, #4A4A4A, #6B6B6B)",this.settingsButton.onclick=()=>this.openSettings(),this.buttonsContainer.appendChild(this.menuButton),this.buttonsContainer.appendChild(this.settingsButton),this.guiContainer.appendChild(this.buttonsContainer)}updateHealth(e){this.health=Math.max(0,Math.min(e,this.maxHealth));const i=this.health/this.maxHealth*100;this.healthBarFill.style.width=`${i}%`,this.healthBarText.textContent=`HEALTH: ${Math.round(this.health)}/${this.maxHealth}`,i>50?this.healthBarFill.style.background="linear-gradient(to right, #5eff00, #ff9900)":i>25?this.healthBarFill.style.background="linear-gradient(to right, #ff9900, #ff0000)":this.healthBarFill.style.background="#ff0000"}takeDamage(e){this.updateHealth(this.health-e)}heal(e){this.updateHealth(this.health+e)}updateDashCooldown(e){this.dashCooldown=e;const i=e/this.maxDashCooldown*100;this.dashBarFill.style.width=`${100-i}%`,e<=0?(this.dashBarText.textContent="DASH: READY",this.isDashReady=!0):(this.dashBarText.textContent=`DASH: ${e.toFixed(1)}s`,this.isDashReady=!1)}startDashCooldown(){if(this.isDashReady){this.isDashReady=!1,this.dashCooldown=this.maxDashCooldown;const e=setInterval(()=>{this.dashCooldown-=.1,this.updateDashCooldown(this.dashCooldown),this.dashCooldown<=0&&(clearInterval(e),this.dashCooldown=0,this.updateDashCooldown(0))},100)}}openMenu(){window.location.href="./index.html"}openSettings(){window.open("./settings.html")}show(){this.guiContainer.style.display="block"}hide(){this.guiContainer.style.display="none"}}class O{constructor(){this.deathScreen=document.getElementById("deathScreen"),this.topOverlay=document.querySelector(".death-overlay.top"),this.bottomOverlay=document.querySelector(".death-overlay.bottom"),this.deathContent=document.querySelector(".death-content"),this.isActive=!1}show(){this.isActive||(this.isActive=!0,this.deathScreen.style.display="block",this.deathScreen.offsetWidth,this.deathScreen.classList.add("active"),setTimeout(()=>{document.addEventListener("keydown",()=>{window.location.href="./index.html"})},2500))}hide(){this.isActive&&(this.isActive=!1,this.deathScreen.classList.remove("active"),setTimeout(()=>{this.isActive||(this.deathScreen.style.display="none")},1e3))}reset(){this.deathScreen.classList.remove("active"),this.deathScreen.style.display="none",this.isActive=!1}}window.deathScreen=new O;class G{constructor(e,i,a,o,s,r,h,c,y,f,x,d,b,C,I,j,S,A,P){this.speed=e,this.maxHealth=y,this.health=f,this.isInvicible=o,this.jumpSpeed=x,this.cameraObject=s,this.isDead=i,this.dashSpeed=d,this.dashRegenerationTime=b,this.dashCooldown=C,this.currentDashes=I,this.dashDuration=h,this.dashInvincibilityTime=c,this.screenEffect=new F,this.gameGUI=new L,this.shootCooldown=j,this.shootDelay=S,this.parryCooldown=A,this.parryDelay=P,this.handsObject=a,this.handAnimations=r}getDamage(e){this.isInvicible||(this.health-=e,this.screenEffect.showEffect(.7),this.gameGUI.takeDamage(e))}changeHealth(e){this.health=e,this.screenEffect.showEffect(.7,"heal"),this.gameGUI.updateHealth(e)}death(){this.isDead=!0,window.deathScreen.show()}}class N{constructor(e,i,a,o,s,r,h,c,y,f,x,d,b,C){this.objects=e,this.lvlName=i,this.loadedObjects=a,this.enemies=o,this.activeInstances=b,this.THREE=s,this.scene=r,this.loader=c,this.gameFieldBounds=h,this.player=y,this.enemyModelTemplate=null,this.enemyToxicModelTemplate=null,this.enemyMageModelTemplate=null,this.toxicProjectileTemplate=null,this.waveCooldown=f,this.waveDelay=x,this.waveNumber=d,this.enemyTypesData=null}loadModel(e){return new Promise((i,a)=>{this.loader.load(e,o=>{const s=o.scene;s.traverse(r=>{r.isMesh&&(r.castShadow=!0,r.receiveShadow=!1)}),s.scale.set(.1,.1,.1),s.position.set(0,-1,0),s.rotation.set(0,0,0),i(s)},void 0,o=>{console.error("Error loading enemy model:",o),a(o)})})}async loadModels(e,i,a,o){try{this.enemyModelTemplate=await this.loadModel(e),this.enemyToxicModelTemplate=await this.loadModel(i),this.enemyMageModelTemplate=await this.loadModel(o),this.toxicProjectileTemplate=await this.loadModel(a)}catch(s){console.error("Failed to load enemy models:",s)}}removeEnemyByID(e){this.enemies.delete(e)}requestWave(e){if(!(this.enemies.size>0)&&(this.waveCooldown-=e,!(this.waveCooldown>0))){if(this.waveNumber<=3){this.spawnEnemy(this.waveNumber,.02,.07),this.waveNumber++,this.waveDelay=4,this.waveCooldown=this.waveDelay;return}if(this.waveNumber<=6){this.spawnEnemy(this.waveNumber,.03,.08),this.waveNumber++,this.waveDelay=5,this.waveCooldown=this.waveDelay;return}if(this.waveNumber<=9){this.spawnEnemy(this.waveNumber,.05,.08),this.waveNumber++,this.waveDelay=6,this.waveCooldown=this.waveDelay;return}}}setGameFieldBounds(){const e=new this.THREE.Box3;e.setFromObject(this.objects[0]);const i=new this.THREE.Vector3;e.getSize(i),this.gameFieldBounds=new this.THREE.Vector3(i.x,0,i.z)}setupInstanceObject(e){const i=crypto.randomUUID();return this.activeInstances.set(i,e),i}fillEnemyTypes(){let e=new Map;e.set(1,{health:3,speedMultiplier:1,type:1,damage:1,modelTemplateName:"enemyModelTemplate",attackDelay:2}),e.set(2,{health:5,speedMultiplier:0,type:2,damage:1,modelTemplateName:"enemyToxicModelTemplate",attackDelay:3}),e.set(3,{health:6,speedMultiplier:.9,type:3,damage:5,modelTemplateName:"enemyMageModelTemplate",attackDelay:3}),this.enemyTypesData=e}spawnEnemy(e=1,i,a,o=40,s=10){for(let r=0;r<e;r++){let h=this.enemyTypesData.get(1),c=Math.floor(Math.random()*100);c<=o&&(h=this.enemyTypesData.get(2)),c<=s&&(h=this.enemyTypesData.get(3));const y=this[h.modelTemplateName].clone(),f=(Math.random()-.5)*this.gameFieldBounds.x,x=(Math.random()-.5)*this.gameFieldBounds.y;y.position.set(f,h.type===3?3:-1,x);let d=new U;d.speed=(Math.random()*(a-i)+i)*h.speedMultiplier,d.maxHealth=h.health,d.health=d.maxHealth,d.damage=h.damage,d.attackDelay=h.attackDelay+Math.floor(Math.random()*3-Math.random()*2),d.attackCooldown=d.attackDelay,d.manager=this,d.enemyModel=y,d.enemyID=crypto.randomUUID(),d.type=h.type,h.type===2&&(d.enemyProjectileModel=this.toxicProjectileTemplate),d.spawn(),this.enemies.set(d.enemyID,d)}}getEnemyByID(e){return this.enemies.get(e)}}class U{constructor(e,i,a,o,s,r,h,c,y,f,x){this.speed=e,this.maxHealth=i,this.health=a,this.damage=f,this.type=x,this.attackCooldown=c,this.attackDelay=y,this.jumpSpeed=o,this.manager=s,this.enemyID=r,this.enemyModel=h,this.enemyProjectileModel=null,this.enemyLightRayCurrent=null,this.isActive=!1,this.isChasing=!1}spawn(){this.manager.scene.add(this.enemyModel),this.enemyModel.traverse(e=>{(e.isMesh||e.isObject3D)&&(e.userData.enemyInstance=this)}),this.isActive=!0,this.startChasing()}startChasing(){this.isChasing=!0}stopChasing(){this.isChasing=!1}update(){if(!this.isActive||!this.isChasing||!this.manager.player)return;if(this.health<=0)return this.remove();const e=this.manager.THREE,i=this.manager.player.cameraObject.position,a=this.enemyModel,o=a.position.clone(),s=new e.Vector3;if(s.subVectors(i,o),s.y=0,s.normalize(),s.length()>.001){const r=Math.atan2(s.x,s.z);a.rotation.y=r}if(this.attackCooldown<=0){if(this.type===2)return this.fireProjectile();if(this.type===3&&!this.enemyLightRayCurrent)return this.fireRay()}if(this.getDistanceToPlayer()<=1){if(this.type!=1)return;if(this.attackCooldown<=0){this.damagePlayer();return}return}a.position.x+=s.x*this.speed,a.position.z+=s.z*this.speed}fireProjectile(){let e=new W;e.damage=2,e.speed=10,e.lifeTime=10,e.manager=this.manager,e.model=this.manager.toxicProjectileTemplate.clone();const i=this.manager.THREE;e.velocity=new i.Vector3;const a=new i.Vector3(0,0,1);this.enemyModel.getWorldDirection(a),e.moveDirection=a.clone(),e.projectileID=this.manager.setupInstanceObject(e),e.instantiate(this.enemyModel.rotation,this.enemyModel.position),this.attackCooldown=this.attackDelay}fireRay(){let e=new V;e.damage=this.damage,e.remainTime=2,e.manager=this.manager,e.speed=.035,e.rayID=this.manager.setupInstanceObject(e),e.instantiate(),this.enemyLightRayCurrent=e,e.parentEnemy=this,this.attackCooldown=this.attackDelay}damagePlayer(){this.manager.player.getDamage(this.damage),this.attackCooldown=this.attackDelay}getDamage(e){this.health-=e}remove(){this.stopChasing(),this.isActive=!1,this.manager.removeEnemyByID(this.enemyID),this.enemyLightRayCurrent&&this.enemyLightRayCurrent.remove(),this.manager.scene.remove(this.enemyModel)}getDistanceToPlayer(){if(!this.manager.player)return 1/0;const e=this.manager.player.cameraObject.position,i=this.enemyModel.position;return Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.z-i.z,2))}}class W{constructor(e,i,a,o,s,r,h,c){this.projectileID=h,this.damage=e,this.speed=i,this.moveDirection=a,this.model=o,this.lifeTime=s,this.isActive=!1,this.manager=r,this.velocity=c,this.isParried=!1}instantiate(e,i){this.manager.scene.add(this.model),this.model.rotation.copy(e),this.model.position.copy(i),this.velocity.copy(this.moveDirection).multiplyScalar(this.speed),this.model.traverse(a=>{(a.isMesh||a.isObject3D)&&(a.userData.Projectile=this)}),this.isActive=!0}update(e){if(!this.isActive||this.lifeTime<=0)return;if(this.moveDirection&&(this.model.position.x+=this.velocity.x*e,this.model.position.z+=this.velocity.z*e),this.lifeTime-=e,this.getDistanceToPlayer()<=1){this.damagePlayer(),this.deactivate();return}if(this.lifeTime<=0&&this.deactivate(),!this.isParried)return;const i=this.getNearEnemy();i&&(this.damageEnemy(i),this.deactivate())}getNearEnemy(){if(this.manager.enemies.size<=0)return null;const e=this.model.position;let i=null;const a=2;return this.manager.enemies.forEach((o,s)=>{if(i)return;this.getDistance(o.enemyModel.position,e)<=a&&(i=o)}),i}getDistanceToPlayer(){return this.manager.player?this.getDistance(this.manager.player.cameraObject.position,this.model.position):1/0}damagePlayer(){this.manager.player.getDamage(this.damage),this.deactivate()}damageEnemy(e){e.getDamage(100)}onParry(){const e=this.manager.THREE,i=this.manager.player.cameraObject,a=new e.Vector3(0,0,-1);i.getWorldDirection(a),this.moveDirection=a.clone(),this.velocity.copy(this.moveDirection).multiplyScalar(this.speed*2);const o=Math.atan2(this.moveDirection.x,this.moveDirection.z);this.model.rotation.y=o,this.isParried=!0}getDistance(e,i){return Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.z-i.z,2))}deactivate(){this.isActive=!1,this.manager.scene.remove(this.model),this.manager.activeInstances.delete(this.projectileID)}}class V{constructor(e,i,a,o,s,r){this.damage=i,this.remainTime=a,this.manager=o,this.player=null,this.parentEnemy=null,this.object=s,this.rayID=e,this.speed=r}instantiate(){const e=this.manager.THREE,i=1,a=32,o=new e.CircleGeometry(i,a),s=new e.MeshBasicMaterial({color:16777215});s.transparent=!0,s.opacity=.2;const r=new e.Mesh(o,s);r.position.copy(this.manager.player.cameraObject.position),r.rotation.x=-Math.PI/2,this.object=r,this.manager.scene.add(this.object),r.position.y-=.99,this.player=this.manager.player}update(e){if(this.object.material.opacity>=1)return this.remainActivated(e);this.object.material.opacity+=e/2,this.object.scale.set(this.object.scale.x+=e,this.object.scale.y+=e,this.object.scale.z+=e);const i=this.manager.THREE,a=new i.Vector3;a.subVectors(this.player.cameraObject.position,this.object.position),a.y=0,a.normalize(),this.object.position.x+=a.x*this.speed,this.object.position.z+=a.z*this.speed}remainActivated(e){this.remainTime-=e,this.remainTime<=0&&this.remove(),this.getDistanceToPlayer()<=this.object.scale.x&&this.damagePlayer()}damagePlayer(){this.player.getDamage(this.damage),this.remove()}getDistanceToPlayer(){if(!this.player)return 1/0;const e=this.player.cameraObject.position,i=this.enemyModel.position;return Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.z-i.z,2))}remove(){this.parentEnemy.enemyLightRayCurrent=null,this.manager.scene.remove(this.object),this.manager.activeInstances.delete(this.rayID)}getDistanceToPlayer(){if(!this.manager.player)return 1/0;const e=this.player.cameraObject.position,i=this.object.position;return Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.z-i.z,2))}}const w={isCursorLocked:!1,sens:1,fov:75,invert:!1};function M(t){const e=JSON.parse(t);Object.entries(e).forEach(([i,a])=>{w[i]===void 0||w[i]===null||(w[i]=a,i==="fov"&&q(a))})}window.addEventListener("storage",t=>{t.key==="settings"&&t.newValue&&M(t.newValue)});const g=new THREE.Scene;let v;g.background=K();const l=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,1e3);g.add(l);M(localStorage.getItem("settings")||JSON.stringify({sens:1,invert:!1}));function q(t){l.fov=t,l.updateProjectionMatrix()}const T=new THREE.Raycaster,u=new THREE.WebGLRenderer({antialias:!0});u.setSize(window.innerWidth,window.innerHeight);u.shadowMap.enabled=!0;u.shadowMap.type=THREE.PCFSoftShadowMap;u.toneMapping=THREE.ACESFilmicToneMapping;u.toneMappingExposure=1;u.setPixelRatio(.7);document.getElementById("app").appendChild(u.domElement);$();function $(){const t=new THREE.DirectionalLight(16777215,1.5);t.position.set(10,20,10),t.castShadow=!0,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,t.shadow.camera.near=1,t.shadow.camera.far=50,t.shadow.camera.left=-20,t.shadow.camera.right=20,t.shadow.camera.top=20,t.shadow.camera.bottom=-20,t.shadow.bias=-.001,g.add(t),t.target.position.set(0,0,0),g.add(t.target);const e=new THREE.AmbientLight(16777215,.8);g.add(e)}function K(){return new THREE.TextureLoader().load("./assets/skybox_default.png",e=>{e.mapping=THREE.EquirectangularReflectionMapping,g.background=e,console.log("Skybox loaded as equirectangular")},void 0,e=>{console.error("Error:",e),g.background=new THREE.Color(8900331)}),new THREE.Color(8900331)}const B=new GLTFLoader;let n=Z();const p=_(),E={},H=new z;X("./models/model.glb");function X(t){B.load(t,function(e){const i=e.scene;i.traverse(a=>{a.isMesh&&(a.castShadow=!1,a.receiveShadow=!1,a.material&&(a.material.roughness=0,a.material.metalness=0))}),i.scale.set(1,1,1),i.position.set(0,-1.65,.1),i.rotation.set(0,135,0),l.add(i),n.handsObject=i,v=new THREE.AnimationMixer(i),v.addEventListener("finished",Y),e.animations.length>0&&(n.handAnimations=e.animations,v.clipAction(e.animations[2]).play())},void 0,function(e){console.error("Error loading model:",e)})}function D(t){if(v&&n){v.stopAllAction();const e=n.handAnimations;if(e&&e.length>0){const i=v.clipAction(e[t]);i.setLoop(THREE.LoopOnce),i.clampWhenFinished=!0,i.reset(),i.play()}}}function Y(){D(2)}function Z(){const t=new G;return t.cameraObject=l,t.isDead=!1,t.speed=10,t.maxHealth=10,t.health=t.maxHealth,t.isInvicible=!1,t.dashSpeed=50,t.dashRegenerationTime=3,t.dashCooldown=0,t.dashDuration=0,t.dashInvincibilityTime=.5,t.shootDelay=.4,t.shootCooldown=0,t.parryDelay=.5,t.parryCooldown=0,t.gameGUI.maxHealth=t.maxHealth,t.gameGUI.health=t.maxHealth,t.gameGUI.maxDashCooldown=t.dashRegenerationTime,t.gameGUI.createGUI(),t}function _(){const t=new N;return t.objects=[],t.enemies=new Map,t.activeInstances=new Map,t.THREE=THREE,t.scene=g,t.loader=B,t.player=n,t.waveDelay=2,t.waveCooldown=3,t.waveNumber=1,t.loadModels("./models/enemy.glb","./models/enemy_toxic.glb","./models/toxic_projectile.glb","./models/enemy_mage.glb"),t.fillEnemyTypes(),t.objects.push(J()),t.setGameFieldBounds(),t}function J(){const t=new THREE.PlaneGeometry(50,50),e=document.createElement("canvas");e.width=1024,e.height=1024;const i=e.getContext("2d");for(let r=0;r<e.width;r+=4)for(let h=0;h<e.height;h+=4){const c=Math.random()*100;i.fillStyle=`rgb(${120+c}, ${100+c*.5}, ${80+c*.3})`,i.fillRect(r,h,4,4)}const a=new THREE.CanvasTexture(e);a.wrapS=THREE.RepeatWrapping,a.wrapT=THREE.RepeatWrapping,a.repeat.set(8,8);const o=new THREE.MeshStandardMaterial({map:a,roughness:.9,metalness:.1,side:THREE.DoubleSide}),s=new THREE.Mesh(t,o);return s.rotation.x=-Math.PI/2,s.position.y=-1,s.receiveShadow=!0,g.add(s),s}function R(t){T.far=t,T.setFromCamera(new THREE.Vector2(0,0),l);const e=T.intersectObjects(g.children);if(e.length>0)return e[0]}const m={velocity:new THREE.Vector3,isMoving:!1,shakeTime:0,moveSpeed:n.speed/100,yaw:0,pitch:0,sensitivity:.002,isLocked:!1};l.position.set(0,0,5);function Q(t){if(!m.isLocked)return;const e=t.movementX||t.mozMovementX||t.webkitMovementX||0,i=t.movementY||t.mozMovementY||t.webkitMovementY||0;m.yaw-=e*m.sensitivity*w.sens*(w.invert?-1:1),m.pitch-=i*m.sensitivity*w.sens*(w.invert?-1:1),m.pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,m.pitch)),l.rotation.order="YXZ",l.rotation.y=m.yaw,l.rotation.x=m.pitch}function ee(t){E[t.code]=!0}function te(t){E[t.code]=!1}function ie(t){!n.isDead&&n.health<=0&&n.death(),n.dashCooldown-=t,n.shootCooldown-=t,n.parryCooldown-=t,n.dashDuration>0?(n.dashDuration-=t,n.isInvicible=!0):n.isInvicible&&(n.isInvicible=!1),p.requestWave&&p.requestWave(t),p.enemies&&p.enemies.forEach((e,i)=>{e.attackCooldown!==void 0&&(e.attackCooldown-=t)})}function ae(){const t=new THREE.Vector3,e=new THREE.Vector3,i=new THREE.Vector3;l.getWorldDirection(e),e.y=0,e.normalize(),i.crossVectors(e,l.up),i.normalize();let a=!1;n.dashCooldown<=0&&(a=E.ShiftLeft);const o=a?n.dashSpeed:1;if(a&&(n.dashDuration=n.dashInvincibilityTime,n.dashCooldown=n.dashRegenerationTime,n.gameGUI&&n.gameGUI.startDashCooldown&&n.gameGUI.startDashCooldown()),E.KeyW&&t.add(e),E.KeyS&&t.sub(e),E.KeyA&&t.sub(i),E.KeyD&&t.add(i),a&&t.length()===0&&t.copy(e),t.length()>0){t.normalize();const r=m.moveSpeed*o;m.velocity.lerp(t.multiplyScalar(r),.2),m.isMoving=!0}else m.velocity.lerp(new THREE.Vector3,.1),m.isMoving=!1,m.shakeTime=0;const s=l.position.clone();if(l.position.add(m.velocity),p&&p.gameFieldBounds){const r=p.gameFieldBounds.x*.5,h=p.gameFieldBounds.z*.5;(l.position.x>r||l.position.x<-r||l.position.z>h||l.position.z<-h)&&l.position.copy(s)}}function se(){let t=R(3);if(t){let e=t.object;if(e.userData&&e.userData.enemyInstance){const i=e.userData.enemyInstance;i.getDamage(.5),H.show();const a=n.cameraObject.position,o=i.enemyModel.position,s=new THREE.Vector3().subVectors(o,a).normalize(),r=5,h=300,c=o.clone().add(s.multiplyScalar(r));if(p&&p.gameFieldBounds){const y=p.gameFieldBounds.x*.5,f=p.gameFieldBounds.z*.5;c.x=THREE.MathUtils.clamp(c.x,-y,y),c.z=THREE.MathUtils.clamp(c.z,-f,f)}new TWEEN.Tween(i.enemyModel.position).to({x:c.x,y:o.y,z:c.z},h).easing(TWEEN.Easing.Quadratic.Out).start()}if(e.userData&&e.userData.Projectile){const i=e.userData.Projectile;n.changeHealth(n.maxHealth),i.onParry()}}D(1),n.parryCooldown=n.parryDelay}function ne(){let t=R(1e3);if(t){let e=t.object;e.userData&&e.userData.enemyInstance&&(e.userData.enemyInstance.getDamage(1),H.show())}D(3),n.shootCooldown=n.shootDelay}function oe(t){u.domElement.requestPointerLock(),w.isCursorLocked=!0,t.button==0&&n.shootCooldown<=0&&ne()}function re(){E.Escape&&w.isCursorLocked&&(document.exitPointerLock(),w.isCursorLocked=!1),E.KeyF&&n.parryCooldown<=0&&se()}document.addEventListener("pointerlockchange",()=>{m.isLocked=!!document.pointerLockElement});u.domElement.addEventListener("mousemove",Q,!1);u.domElement.addEventListener("mousedown",oe,!1);window.addEventListener("keydown",ee);window.addEventListener("keyup",te);window.addEventListener("resize",()=>{l.aspect=window.innerWidth/window.innerHeight,l.updateProjectionMatrix(),u.setSize(window.innerWidth,window.innerHeight),u.setPixelRatio(.7)});const he=new THREE.Clock;function k(){if(n.isDead)return;requestAnimationFrame(k),re(),TWEEN.update();const t=he.getDelta();p.enemies&&p.enemies.forEach((e,i)=>{e.update&&e.update()}),p.activeInstances&&p.activeInstances.forEach((e,i)=>{e.update&&e.update(t)}),ae(),ie(t),v&&v.update(t),u.render(g,l)}k();
